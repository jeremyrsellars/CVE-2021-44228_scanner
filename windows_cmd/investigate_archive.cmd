@echo off
setlocal
:: Given an archive filename %1, extracts interesting files into a directory named investigate_dir\%~nx1.extracted.

echo.
echo === Processing %1
::pause

if exist "%~dp0investigate_dir\%~nx1.extracted" echo Directory already exists "%~dp0investigate_dir\%~nx1.extracted"
if exist "%~dp0investigate_dir\%~nx1.extracted" goto :eof
if exist "%~dp0investigate_dir\%~nx1.extracted" rd /q/s "%~dp0investigate_dir\%~nx1.extracted"
echo Creating directory "%~dp0investigate_dir\%~nx1.extracted"
md "%~dp0investigate_dir\%~nx1.extracted"
unzip.exe -q -n -C "%~1" *log4j* *.jar *.war *.ear *.rar *.zip log4j-core-*.jar *JndiLookup.class -d "%~dp0investigate_dir\%~nx1.extracted" >nul 2>nul

pushd "%~nx1.extracted"
:: Check newly extracted files
dir /s/b *JndiLookup.class 2>nul
if not errorlevel 1 echo Please check the above file
if not errorlevel 1 pause

:: Check sub-archives (if any)
echo Checking sub-directores of %CD%
for /r %%f in (*.jar *.war *.ear *.rar *.zip) do call "%~dp0investigate_archive.cmd" "%%~f"
popd

echo === Done processing %1
